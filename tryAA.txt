<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f9; padding: 20px; text-align: right; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1, h2 { text-align: center; color: #333; }
        label { display: block; margin-top: 10px; font-weight: bold; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 10px; margin-top: 20px; background: #28a745; color: white; border: none; cursor: pointer; font-size: 16px; border-radius: 4px; }
        button:hover { background: #218838; }
        button.delete { background: #dc3545; margin-top: 5px; width: auto; padding: 5px 10px; float: left;}
        
        /* × ×™×•×•×˜ ×‘×™×Ÿ ××¡×›×™× */
        .nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .nav button { margin-top: 0; background: #007bff; }
        
        .hidden { display: none; }
        .result-box { background: #e9ecef; padding: 10px; margin-top: 15px; border-radius: 5px; }
        ul { list-style: none; padding: 0; }
        li { background: #fff; border-bottom: 1px solid #ddd; padding: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>× ×™×”×•×œ ××¡×¢×“×”</h1>
    
    <div class="nav">
        <button onclick="showSection('reportSection')">ğŸ“ ×“×™×•×•×— ××©××¨×ª</button>
        <button onclick="showSection('adminSection')" style="background: #6c757d;">ğŸ‘® ×× ×”×œ / ×”×’×“×¨×•×ª</button>
    </div>

    <div id="reportSection">
        <h2>×“×™×•×•×— ×©×¢×•×ª</h2>
        <label>×‘×—×¨ ×¢×•×‘×“:</label>
        <select id="employeeSelect">
            <option value="">×˜×•×¢×Ÿ ×¢×•×‘×“×™×...</option>
        </select>

        <label>×©×¢×ª ×”×ª×—×œ×”:</label>
        <input type="time" id="startTime">

        <label>×©×¢×ª ×¡×™×•×:</label>
        <input type="time" id="endTime">

        <label>×¡×”"×› ×˜×™×¤×™× ×‘×§×•×¤×” (â‚ª):</label>
        <input type="number" id="totalTips" placeholder="0">

        <button onclick="calculateAndSave()">×©××•×¨ ×•×—×©×‘ ×©×›×¨</button>

        <div id="calcResult" class="result-box hidden">
            </div>
    </div>

    <div id="adminSection" class="hidden">
        <h2>×”×’×“×¨×•×ª ×¢×¡×§</h2>
        <label>×©×›×¨ ×‘×¡×™×¡ ×œ×©×¢×” (×‘×•×§×¨):</label>
        <input type="number" id="settingBaseWage">
        
        <label>××™× ×™××•× ×©×¢×¨ ×œ×©×¢×” (×¢×¨×‘ + ×˜×™×¤):</label>
        <input type="number" id="settingMinEvening">

        <label>×©×¢×ª ×ª×—×™×œ×ª ×¢×¨×‘ (×œ××©×œ 17:00):</label>
        <input type="time" id="settingEveningStart">
        
        <button onclick="saveSettings()">×©××•×¨ ×”×’×“×¨×•×ª</button>
        <hr>

        <h3>× ×™×”×•×œ ×¢×•×‘×“×™×</h3>
        <input type="text" id="newEmpName" placeholder="×©× ×”×¢×•×‘×“">
        <input type="text" id="newEmpId" placeholder="×ª×¢×•×“×ª ×–×”×•×ª">
        <select id="newEmpRole">
            <option value="waiter">××œ×¦×¨ (××§×‘×œ ×˜×™×¤×™×)</option>
            <option value="kitchen">××˜×‘×—</option>
            <option value="regular">×›×œ×œ×™</option>
        </select>
        <button onclick="addEmployee()" style="background: #17a2b8;">×”×•×¡×£ ×¢×•×‘×“ ×œ××¢×¨×›×ª</button>
        
        <h4>×¨×©×™××ª ×¢×•×‘×“×™×:</h4>
        <ul id="employeesListDisplay"></ul>
    </div>

</div>

<script type="module">
  // ×™×™×‘×•× ×”×¤×•× ×§×¦×™×•×ª ××¤×™×™×¨×‘×™×™×¡ ×“×¨×š ×”××™× ×˜×¨× ×˜
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, doc, setDoc, getDoc, deleteDoc } 
    from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  // --- ×”×’×“×¨×•×ª ×¤×™×™×¨×‘×™×™×¡ (×ª×“×‘×™×§ ××ª ×©×œ×š ×›××Ÿ!) ---
 const firebaseConfig = {
  apiKey: "AIzaSyCFbeJWhbsGbcgwHBZywYNAdV5iDJ7RSdc",
  authDomain: "inbar-website.firebaseapp.com",
  projectId: "inbar-website",
  storageBucket: "inbar-website.firebasestorage.app",
  messagingSenderId: "2603275288",
  appId: "1:2603275288:web:28388114b71fcaf7235f6d",
  measurementId: "G-NJ5LJ6RNEF"
  };

  // ××ª×—×•×œ ×”××¤×œ×™×§×¦×™×”
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
  let currentSettings = { morningWage: 32, eveningMinWage: 45, eveningStartHour: "17:00" };
  let allEmployees = [];

  // ==========================================
  // 1. ×¤×•× ×§×¦×™×•×ª ×œ×•×’×™×§×” (×”××•×— ×©×œ ×”××¢×¨×›×ª)
  // ==========================================
  
  window.showSection = (sectionId) => {
      document.getElementById('reportSection').classList.add('hidden');
      document.getElementById('adminSection').classList.add('hidden');
      document.getElementById(sectionId).classList.remove('hidden');
  }

  // ×˜×¢×™× ×ª × ×ª×•× ×™× ×¨××©×•× ×™×ª
  async function loadInitialData() {
      // ×˜×¢×™× ×ª ×”×’×“×¨×•×ª
      const docRef = doc(db, "config", "businessRules");
      const docSnap = await getDoc(docRef);
      if (docSnap.exists()) {
          currentSettings = docSnap.data();
          // ×¢×“×›×•×Ÿ ×”×©×“×•×ª ×‘××¡×š ××“××™×Ÿ
          document.getElementById('settingBaseWage').value = currentSettings.morningWage;
          document.getElementById('settingMinEvening').value = currentSettings.eveningMinWage;
          document.getElementById('settingEveningStart').value = currentSettings.eveningStartHour;
      }

      // ×˜×¢×™× ×ª ×¢×•×‘×“×™×
      await loadEmployees();
  }

  async function loadEmployees() {
      const querySnapshot = await getDocs(collection(db, "employees"));
      allEmployees = [];
      const selectBox = document.getElementById('employeeSelect');
      const listBox = document.getElementById('employeesListDisplay');
      
      selectBox.innerHTML = '<option value="">-- ×‘×—×¨ ×¢×•×‘×“ --</option>';
      listBox.innerHTML = '';

      querySnapshot.forEach((doc) => {
          const emp = { id: doc.id, ...doc.data() };
          allEmployees.push(emp);
          
          // ×”×•×¡×¤×” ×œ-Select (××¡×š ×“×™×•×•×—)
          const opt = document.createElement("option");
          opt.value = emp.id;
          opt.text = emp.name;
          selectBox.appendChild(opt);

          // ×”×•×¡×¤×” ×œ×¨×©×™××” (××¡×š ××“××™×Ÿ)
          const li = document.createElement("li");
          li.innerHTML = `${emp.name} (${emp.role}) <button class="delete" onclick="window.deleteEmployee('${emp.id}')">××—×§</button>`;
          listBox.appendChild(li);
      });
  }

  // ==========================================
  // 2. ×¤×¢×•×œ×•×ª ××“××™×Ÿ
  // ==========================================

  window.saveSettings = async () => {
      const newSettings = {
          morningWage: Number(document.getElementById('settingBaseWage').value),
          eveningMinWage: Number(document.getElementById('settingMinEvening').value),
          eveningStartHour: document.getElementById('settingEveningStart').value
      };
      
      await setDoc(doc(db, "config", "businessRules"), newSettings);
      currentSettings = newSettings;
      alert("×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!");
  }

  window.addEmployee = async () => {
      const name = document.getElementById('newEmpName').value;
      const idNum = document.getElementById('newEmpId').value;
      const role = document.getElementById('newEmpRole').value;
      
      if(!name) return alert("×—×•×‘×” ×œ×”×›× ×™×¡ ×©×");

      await addDoc(collection(db, "employees"), { name, idNum, role });
      
      // ××™×¤×•×¡ ×©×“×•×ª
      document.getElementById('newEmpName').value = '';
      document.getElementById('newEmpId').value = '';
      
      alert("×¢×•×‘×“ × ×•×¡×£!");
      loadEmployees(); // ×¨×¢× ×•×Ÿ ×”×¨×©×™××”
  }

  window.deleteEmployee = async (id) => {
      if(confirm("×œ××—×•×§ ×¢×•×‘×“ ×–×”?")) {
          await deleteDoc(doc(db, "employees", id));
          loadEmployees();
      }
  }

  // ==========================================
  // 3. ×¤×¢×•×œ×•×ª ×“×™×•×•×— ×•×—×™×©×•×‘ (×”×œ×‘ ×©×œ ×”××¤×œ×™×§×¦×™×”)
  // ==========================================

  window.calculateAndSave = async () => {
      const empId = document.getElementById('employeeSelect').value;
      const startStr = document.getElementById('startTime').value;
      const endStr = document.getElementById('endTime').value;
      const tips = Number(document.getElementById('totalTips').value);

      if(!empId || !startStr || !endStr) return alert("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");

      const employee = allEmployees.find(e => e.id === empId);
      
      // --- ××œ×’×•×¨×™×ª× ×”×—×™×©×•×‘ ---
      const cutoffHour = parseInt(currentSettings.eveningStartHour.split(':')[0]);
      
      function timeToDec(t) { 
          const [h, m] = t.split(':').map(Number); 
          return h + m/60; 
      }
      
      const start = timeToDec(startStr);
      const end = timeToDec(endStr);
      const totalHours = end - start;

      let morningHours = 0;
      let eveningHours = 0;

      if (end <= cutoffHour) {
          morningHours = totalHours;
      } else if (start >= cutoffHour) {
          eveningHours = totalHours;
      } else {
          morningHours = cutoffHour - start;
          eveningHours = end - cutoffHour;
      }

      let pay = 0;
      let supplement = 0;

      // ×ª×©×œ×•× ×‘×•×§×¨
      pay += morningHours * currentSettings.morningWage;

      // ×ª×©×œ×•× ×¢×¨×‘
      if (employee.role === 'waiter' && eveningHours > 0) {
          const tipsPerHour = tips / eveningHours;
          if (tipsPerHour < currentSettings.eveningMinWage) {
              supplement = (currentSettings.eveningMinWage - tipsPerHour) * eveningHours;
              pay += tips + supplement;
          } else {
              pay += tips;
          }
      } else {
          pay += eveningHours * currentSettings.morningWage; 
      }

      // ×©××™×¨×” ×œ-DB
      await addDoc(collection(db, "shifts"), {
          employeeName: employee.name,
          date: new Date(),
          start: startStr,
          end: endStr,
          totalPay: pay.toFixed(2),
          tips: tips,
          supplement: supplement.toFixed(2)
      });

      // ×”×¦×’×ª ×ª×•×¦××” ×œ××¡×š
      const resultDiv = document.getElementById('calcResult');
      resultDiv.classList.remove('hidden');
      resultDiv.innerHTML = `
          <strong>××©××¨×ª × ×©××¨×”!</strong><br>
          ×©×¢×•×ª ×‘×•×§×¨: ${morningHours.toFixed(2)} | ×©×¢×•×ª ×¢×¨×‘: ${eveningHours.toFixed(2)}<br>
          ×”×©×œ××” ××”×¢×¡×§: ${supplement.toFixed(2)} â‚ª<br>
          <h2>×¡×”"×› ×œ×ª×©×œ×•× ×œ×¢×•×‘×“: ${pay.toFixed(2)} â‚ª</h2>
      `;
  }

  // ×”×¤×¢×œ×” ×¨××©×•× ×™×ª
  loadInitialData();

</script>

</body>
</html>
