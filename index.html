<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ Inbar</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c3e50; --secondary: #3498db; --accent: #e74c3c; --bg: #f8f9fa; --success: #27ae60; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        
        /* Login Styles */
        #loginScreen { display: flex; justify-content: center; align-items: center; height: 100vh; }
        .login-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .login-box button { width: 100%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .login-box button:hover { background: #2980b9; }

        /* Dashboard Styles */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
        
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; border: 1px solid #eee; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px rgba(0,0,0,0.1); border-color: var(--secondary); }
        .card h3 { margin: 10px 0; color: var(--primary); font-size: 1.1em; }
        .card-icon { font-size: 35px; margin-bottom: 10px; }

        /* Modal / Sections */
        .section-view { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); margin-top: 20px; position: relative; }
        .close-btn { position: absolute; top: 15px; left: 15px; background: #e74c3c; color: white; border: none; padding: 5px 12px; border-radius: 5px; cursor: pointer; }
        .hidden { display: none !important; }

        /* Form & Tables */
        .form-group { margin-bottom: 15px; text-align: right; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; font-size: 0.9em; }
        th { background: var(--primary); color: white; }
        
        /* Calendar Styles */
        .cal-controls { display: flex; justify-content: space-between; align-items: center; gap: 10px; margin-bottom: 15px; background: #eee; padding: 10px; border-radius: 8px; }
        .cal-controls button { background: white; border: 1px solid #ccc; padding: 5px 15px; border-radius: 5px; cursor: pointer; font-size: 1.2em; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 10px; direction: rtl; }
        .cal-day-header { text-align: center; font-weight: bold; padding: 10px; background: #eee; border-radius: 4px; }
        .cal-day { background: #fff; border: 1px solid #ddd; padding: 5px; min-height: 100px; font-size: 0.9em; position: relative; border-radius: 4px; }
        .cal-day.empty { background: transparent; border: none; }
        .cal-day.today { border: 2px solid var(--secondary); }
        .shift-marker { font-size: 0.8em; background: var(--primary); color: white; padding: 3px; border-radius: 3px; margin-bottom: 3px; display: block; cursor: pointer; }
        
        /* Toggle & Checkbox */
        .toggle-btn { background: #f1f1f1; border: none; padding: 8px; cursor: pointer; border-radius: 4px; font-size: 0.9em; margin-top: 5px; }

    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <h2 style="color:var(--primary); margin-top:0;">×›× ×™×¡×” ×œ××¢×¨×›×ª</h2>
            <input type="text" id="uName" placeholder="×©× ××©×ª××©" onkeydown="checkEnter(event)">
            <input type="password" id="uPass" placeholder="×¡×™×¡××”" onkeydown="checkEnter(event)">
            <input type="password" id="uMFA" placeholder="×§×•×“ ××‘×˜×—×” (MFA)" onkeydown="checkEnter(event)" style="border-color: var(--secondary);">
            <button onclick="doLogin()">×›× ×™×¡×”</button>
        </div>
    </div>

    <div id="dashboard" class="hidden">
        <div class="header">
            <div>
                <h2 style="margin:0;">××¢×¨×›×ª × ×™×”×•×œ ××©××¨×•×ª</h2>
                <span id="welcomeUser" style="color:gray;"></span>
            </div>
            <button onclick="location.reload()" style="background:var(--accent); color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">×™×¦×™××”</button>
        </div>

        <div class="grid-container" id="menuGrid">
            <div class="card" onclick="openSection('entrySection'); initEntryForm();">
                <div class="card-icon">â±ï¸</div>
                <h3>×”×›× ×¡×ª ××©××¨×ª</h3>
            </div>

            <div class="card" onclick="openSection('calendarSection'); loadCalendar();">
                <div class="card-icon">ğŸ“…</div>
                <h3>×™×•××Ÿ ××©××¨×•×ª</h3>
            </div>

            <div class="card" onclick="openSection('reportSection'); loadReportTable();">
                <div class="card-icon">ğŸ“Š</div>
                <h3>×“×•×—×•×ª ×•×™×™×¦×•×</h3>
            </div>
            
            <div class="card" onclick="openSection('newEmployeeSection');">
                <div class="card-icon">ğŸ‘¤</div>
                <h3>×”×§××ª ×¢×•×‘×“ ×—×“×©</h3>
            </div>
        </div>

        <div id="entrySection" class="section-view hidden">
            <button class="close-btn" onclick="closeSections()">X ×¡×’×•×¨</button>
            <h3>×”×•×¡×¤×ª ××©××¨×ª ×—×“×©×”</h3>
            <div style="max-width: 600px; margin: 0 auto;">
                <div class="form-group">
                    <label>×‘×—×¨ ×¢×•×‘×“:</label>
                    <select id="shiftEmpSelect" onchange="checkTipEligibility()"></select>
                </div>
                
                <div class="form-group">
                    <label>×ª××¨×™×š ×”××©××¨×ª:</label>
                    <input type="date" id="shiftDate">
                </div>

                <div style="display: flex; gap: 15px;">
                    <div class="form-group" style="flex:1;">
                        <label>×©×¢×ª ×”×ª×—×œ×”:</label>
                        <input type="time" id="shiftTimeStart" required>
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>×©×¢×ª ×¡×™×•×:</label>
                        <input type="time" id="shiftTimeEnd" required>
                    </div>
                </div>

                <div style="background: #f9f9f9; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                        <input type="checkbox" id="includeTips" style="width:auto; transform: scale(1.5);">
                        <label for="includeTips" style="margin:0; cursor:pointer;">×¢×•×‘×“ ×–×” ×–×›××™ ×œ×˜×™×¤×™× ×‘××©××¨×ª ×–×•</label>
                    </div>

                    <div class="form-group">
                        <label>×¡×”"×› ×˜×™×¤×™× (â‚ª):</label>
                        <input type="number" id="shiftTips" value="0">
                    </div>

                    <hr style="border:0; border-top:1px solid #ddd; margin:15px 0;">

                    <button type="button" class="toggle-btn" onclick="toggleSpecialWage()" id="btnSpecialWage">ğŸ’° ×”×’×“×¨ ×©×›×¨ ××™×•×—×“ ×œ××©××¨×ª ×–×•</button>
                    <div id="specialWageContainer" class="hidden" style="margin-top:10px;">
                        <label>×ª×¢×¨×™×£ ×©×¢×ª×™ ××™×•×—×“ (â‚ª):</label>
                        <input type="number" id="specialWageInput" placeholder="×”×›× ×¡ ×©×›×¨ ×œ×©×¢×”">
                    </div>
                </div>

                <button onclick="saveShift()" style="width:100%; background:var(--secondary); color:white; padding:12px; border:none; border-radius:5px; font-size:16px; cursor:pointer;">×©××•×¨ ××©××¨×ª</button>
            </div>
        </div>

        <div id="calendarSection" class="section-view hidden">
            <button class="close-btn" onclick="closeSections()">X ×¡×’×•×¨</button>
            <h3>×™×•××Ÿ ××©××¨×•×ª</h3>
            
            <div class="cal-controls">
                <div>
                    <label>×¡×™× ×•×Ÿ ×œ×¤×™ ×¢×•×‘×“:</label>
                    <select id="calFilterUser" onchange="loadCalendar()" style="padding: 5px; width: auto; min-width: 150px;">
                        <option value="all">×”×¦×’ ××ª ×›×•×œ×</option>
                    </select>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button onclick="changeMonth(-1)">â—€</button>
                    <span id="calMonthTitle" style="font-weight:bold; min-width:120px; text-align:center;"></span>
                    <button onclick="changeMonth(1)">â–¶</button>
                </div>
            </div>

            <div class="calendar-grid" id="calendarGrid">
                <div class="cal-day-header">×'</div>
                <div class="cal-day-header">×‘'</div>
                <div class="cal-day-header">×’'</div>
                <div class="cal-day-header">×“'</div>
                <div class="cal-day-header">×”'</div>
                <div class="cal-day-header">×•'</div>
                <div class="cal-day-header">×©'</div>
            </div>
        </div>

        <div id="reportSection" class="section-view hidden">
            <button class="close-btn" onclick="closeSections()">X ×¡×’×•×¨</button>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>×¨×™×›×•×– × ×ª×•× ×™×</h3>
                <button onclick="exportExcel()" style="background:#27ae60; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer;">ğŸ“¥ ×”×•×¨×“ ×œ××§×¡×œ</button>
            </div>
            <div style="overflow-x:auto;">
                <table id="mainTable">
                    <thead>
                        <tr>
                            <th>×¢×•×‘×“</th>
                            <th>×ª"×–</th>
                            <th>×”×ª×—×œ×”</th>
                            <th>×¡×™×•×</th>
                            <th>×©×¢×•×ª</th>
                            <th>×ª×¢×¨×™×£</th>
                            <th>×˜×™×¤×™×</th>
                            <th>×”×©×œ××”</th>
                            <th>×¡×”"×›</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="newEmployeeSection" class="section-view hidden">
            <button class="close-btn" onclick="closeSections()">X ×¡×’×•×¨</button>
            <h3>×”×§××ª ×¢×•×‘×“ ×—×“×© ×‘××¢×¨×›×ª</h3>
            <div style="max-width: 500px; margin: 0 auto;">
                <div class="form-group">
                    <label>×©× ××œ×:</label>
                    <input type="text" id="neName" placeholder="×œ××©×œ: ×“× ×™ ×›×”×Ÿ">
                </div>
                <div class="form-group">
                    <label>×ª×¢×•×“×ª ×–×”×•×ª:</label>
                    <input type="text" id="neId" placeholder="××¡×¤×¨ ×ª.×–.">
                </div>
                <div class="form-group">
                    <label>×©× ××©×ª××© ×œ×›× ×™×¡×”:</label>
                    <input type="text" id="neUser" placeholder="×‘×× ×’×œ×™×ª, ×œ××©×œ: dany">
                </div>
                <div class="form-group">
                    <label>×¡×™×¡××” ×¨××©×•× ×™×ª:</label>
                    <input type="text" id="nePass" value="123456">
                </div>
                <div class="form-group">
                    <label>×©×›×¨ ×‘×¡×™×¡ ×œ×©×¢×” (â‚ª):</label>
                    <input type="number" id="neWage" placeholder="30">
                </div>
                
                <p style="font-size:0.8em; color:gray;">* ×”×¢×•×‘×“ ×™×•×’×“×¨ ××•×˜×•××˜×™×ª ×›×¢×•×‘×“ ×–×›××™ ×œ×˜×™×¤×™×.</p>
                <button onclick="createNewEmployee()" style="width:100%; background:var(--secondary); color:white; padding:12px; border:none; border-radius:5px; font-size:16px; cursor:pointer;">×¦×•×¨ ×¢×•×‘×“</button>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, getDoc, query, where } 
          from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // === ğŸ”´ ×”×’×“×¨×•×ª FIREBASE ×©×œ×š ğŸ”´ ===
        const firebaseConfig = {
          apiKey: "AIzaSyCFbeJWhbsGbcgwHBZywYNAdV5iDJ7RSdc",
  authDomain: "inbar-website.firebaseapp.com",
  projectId: "inbar-website",
  storageBucket: "inbar-website.firebasestorage.app",
  messagingSenderId: "2603275288",
  appId: "1:2603275288:web:28388114b71fcaf7235f6d",
  measurementId: "G-NJ5LJ6RNEF"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
        let allUsers = []; 
        let allRoles = {}; 
        let currentDateView = new Date(); 

        // === 1. ×œ×•×’×™×§×ª ×›× ×™×¡×” ===
        window.checkEnter = (e) => { if (e.key === "Enter") window.doLogin(); }

        window.doLogin = async () => {
            const uName = document.getElementById('uName').value;
            const uPass = document.getElementById('uPass').value;
            const uMFA = document.getElementById('uMFA').value;

            if (!uName || !uPass || !uMFA) return alert("× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");

            try {
                const configDoc = await getDoc(doc(db, "config", "security"));
                if (!configDoc.exists() || configDoc.data().mfaCode !== uMFA) {
                    return alert("×§×•×“ ××‘×˜×—×” (MFA) ×©×’×•×™!");
                }

                const q = query(collection(db, "users"), where("username", "==", uName));
                const snapshot = await getDocs(q);
                
                let foundUser = null;
                snapshot.forEach(d => {
                    const data = d.data();
                    if(data.password === uPass) foundUser = data;
                });

                if (foundUser) {
                    await initSystem(foundUser);
                } else {
                    alert("×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×");
                }
            } catch (e) {
                console.error(e);
                alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª: ×‘×“×•×§ ××ª ×”-Console");
            }
        };

        async function initSystem(user) {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('welcomeUser').innerText = `×©×œ×•×, ${user.name}`;

            // ×˜×¢×™× ×ª ×ª×¤×§×™×“×™×
            const rolesSnap = await getDocs(collection(db, "roles"));
            rolesSnap.forEach(d => { allRoles[d.id] = d.data(); });

            // ×˜×¢×™× ×ª ×¢×•×‘×“×™× (×¨×§ ×¢×•×‘×“×™× ×¨×’×™×œ×™×, ×œ× ×× ×”×œ×™×)
            await loadEmployeesLists();
        }

        async function loadEmployeesLists() {
            allUsers = [];
            const usersSnap = await getDocs(collection(db, "users"));
            
            // ××™×¤×•×¡ ×¡×œ×§×˜×™×
            const shiftSelect = document.getElementById('shiftEmpSelect');
            const calFilter = document.getElementById('calFilterUser');
            
            shiftSelect.innerHTML = '<option value="">-- ×‘×—×¨ ×¢×•×‘×“ --</option>';
            calFilter.innerHTML = '<option value="all">×”×¦×’ ××ª ×›×•×œ×</option>';

            usersSnap.forEach(d => {
                const u = d.data();
                // ×¡×™× ×•×Ÿ: ×œ× ××¦×™×’×™× Super ××• Manager ×‘×¨×©×™××•×ª ×”×¢×‘×•×“×”
                if (u.role !== 'super' && u.role !== 'manager') {
                    allUsers.push(u);
                    
                    // ×”×•×¡×¤×” ×œ-Shift Select
                    const opt1 = document.createElement('option');
                    opt1.value = u.username;
                    opt1.innerText = `${u.name} (×ª"×–: ${u.idNum})`; // ×”×¦×’×ª ×ª"×– ×‘××§×•× ×ª×¤×§×™×“
                    shiftSelect.appendChild(opt1);

                    // ×”×•×¡×¤×” ×œ-Calendar Filter
                    const opt2 = document.createElement('option');
                    opt2.value = u.username;
                    opt2.innerText = u.name;
                    calFilter.appendChild(opt2);
                }
            });
        }

        // === 2. × ×™×”×•×œ UI ===
        window.openSection = (id) => {
            document.querySelectorAll('.section-view').forEach(el => el.classList.add('hidden'));
            document.getElementById('menuGrid').classList.add('hidden'); 
            document.getElementById(id).classList.remove('hidden'); 
        };

        window.closeSections = () => {
            document.querySelectorAll('.section-view').forEach(el => el.classList.add('hidden'));
            document.getElementById('menuGrid').classList.remove('hidden'); 
        };

        // === 3. ×”×•×¡×¤×ª ×¢×•×‘×“ ×—×“×© ===
        window.createNewEmployee = async () => {
            const name = document.getElementById('neName').value;
            const idNum = document.getElementById('neId').value;
            const username = document.getElementById('neUser').value;
            const pass = document.getElementById('nePass').value;
            const wage = document.getElementById('neWage').value;

            if(!name || !idNum || !username || !pass || !wage) return alert("×—×•×‘×” ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª");

            try {
                // ×‘×“×™×§×” ×× ××©×ª××© ×§×™×™×
                const q = query(collection(db, "users"), where("username", "==", username));
                const snap = await getDocs(q);
                if(!snap.empty) return alert("×©× ××©×ª××© ×–×” ×›×‘×¨ ×ª×¤×•×¡!");

                // ×™×¦×™×¨×ª ×”×¢×•×‘×“
                await addDoc(collection(db, "users"), {
                    name: name,
                    idNum: idNum,
                    username: username,
                    password: pass,
                    role: "waiter", // ×‘×¨×™×¨×ª ××—×“×œ: ×¢×•×‘×“ ×˜×™×¤×™×
                    specificWage: Number(wage), // ×©×›×¨ ××™×©×™
                    jobType: "waiter"
                });

                alert("×¢×•×‘×“ × ×•×¦×¨ ×‘×”×¦×œ×—×”!");
                closeSections();
                await loadEmployeesLists(); // ×¨×¢× ×•×Ÿ ×¨×©×™××•×ª
                
                // × ×™×§×•×™ ×˜×•×¤×¡
                document.getElementById('neName').value = '';
                document.getElementById('neId').value = '';
                document.getElementById('neUser').value = '';
                document.getElementById('neWage').value = '';

            } catch(e) {
                console.error(e);
                alert("×©×’×™××” ×‘×™×¦×™×¨×”");
            }
        };

        // === 4. ×”×›× ×¡×ª ××©××¨×ª ===
        window.initEntryForm = () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('shiftDate').value = today;
            document.getElementById('shiftTimeStart').value = '';
            document.getElementById('shiftTimeEnd').value = '';
            document.getElementById('shiftTips').value = '0';
            document.getElementById('specialWageInput').value = '';
            document.getElementById('specialWageContainer').classList.add('hidden');
            document.getElementById('includeTips').checked = true; // ×‘×¨×™×¨×ª ××—×“×œ ×›×Ÿ
        };

        window.checkTipEligibility = () => {
            // ×ª××™×“ ×‘×¨×™×¨×ª ××—×“×œ ×›×Ÿ, ××œ× ×× ×”××©×ª××© ××©× ×”
            document.getElementById('includeTips').checked = true;
        }

        window.toggleSpecialWage = () => {
            document.getElementById('specialWageContainer').classList.toggle('hidden');
        }

        window.saveShift = async () => {
            const username = document.getElementById('shiftEmpSelect').value;
            const dateStr = document.getElementById('shiftDate').value;
            const timeStart = document.getElementById('shiftTimeStart').value;
            const timeEnd = document.getElementById('shiftTimeEnd').value;
            const tips = Number(document.getElementById('shiftTips').value);
            const includeTips = document.getElementById('includeTips').checked;
            const specialWageVal = document.getElementById('specialWageInput').value;

            if(!username || !dateStr || !timeStart || !timeEnd) return alert("× × ×œ××œ× ××ª ×›×œ ×©×“×•×ª ×”×—×•×‘×”");

            const user = allUsers.find(u => u.username === username);
            // ×× ××™×Ÿ ×”×’×“×¨×ª ×©×›×¨ ×‘-DB, × ×™×§×— 0 ×›×‘×¨×™×¨×ª ××—×“×œ
            const roleConfig = allRoles[user.role] || { baseWage: 0, minTipWage: 0 }; 

            let startDateTime = new Date(`${dateStr}T${timeStart}`);
            let endDateTime = new Date(`${dateStr}T${timeEnd}`);

            if (endDateTime <= startDateTime) endDateTime.setDate(endDateTime.getDate() + 1);

            const diffMs = endDateTime - startDateTime;
            const totalHours = diffMs / (1000 * 60 * 60);

            // ×§×‘×™×¢×ª ×©×›×¨: ×× ×™×© ×©×›×¨ ××™×©×™ ×‘×™×•×–×¨ > ×©×›×¨ ×ª×¤×§×™×“
            let hourlyWage = user.specificWage ? user.specificWage : roleConfig.baseWage;
            
            // ×©×›×¨ ××™×•×—×“ ×œ××©××¨×ª ×“×•×¨×¡ ×”×›×œ
            if (specialWageVal && Number(specialWageVal) > 0) {
                hourlyWage = Number(specialWageVal);
            }

            let finalPay = 0;
            let supplement = 0;

            if (includeTips) {
                const tipsPerHour = tips / totalHours;
                const minWage = roleConfig.minTipWage; // ××’×™×¢ ××”×’×“×¨×ª ×”×ª×¤×§×™×“ (waiter)
                
                if (tipsPerHour < minWage) {
                    supplement = (minWage - tipsPerHour) * totalHours;
                    finalPay = tips + supplement;
                } else {
                    finalPay = tips;
                }
            } else {
                finalPay = totalHours * hourlyWage;
            }

            try {
                await addDoc(collection(db, "shifts"), {
                    employeeName: user.name,
                    idNum: user.idNum, // ×©××™×¨×ª ×ª"×–
                    username: user.username,
                    roleTitle: roleConfig.title || "×¢×•×‘×“",
                    start: startDateTime.toISOString(),
                    end: endDateTime.toISOString(),
                    totalHours: totalHours.toFixed(2),
                    hourlyWage: hourlyWage,
                    tips: tips,
                    isTippedShift: includeTips,
                    supplement: supplement.toFixed(2),
                    finalPay: finalPay.toFixed(2),
                    createdAt: new Date()
                });
                alert("××©××¨×ª × ×©××¨×” ×‘×”×¦×œ×—×”!");
                closeSections();
            } catch(e) {
                console.error(e);
                alert("×©×’×™××” ×‘×©××™×¨×”");
            }
        };

        // === 5. ×“×•×—×•×ª ×•×œ×•×— ×©× ×” ===
        async function fetchShifts() {
            const q = query(collection(db, "shifts")); 
            const snap = await getDocs(q);
            const shifts = [];
            snap.forEach(d => shifts.push(d.data()));
            return shifts.sort((a,b) => new Date(b.start) - new Date(a.start));
        }

        // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×¤×•×¨××˜ ×©×¢×” 24
        function formatTime24(dateObj) {
            return dateObj.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit', hour12: false });
        }

        window.loadReportTable = async () => {
            const shifts = await fetchShifts();
            const tbody = document.querySelector('#mainTable tbody');
            tbody.innerHTML = '';

            shifts.forEach(s => {
                const dStart = new Date(s.start);
                const dEnd = new Date(s.end);
                
                const dateStr = dStart.toLocaleDateString('he-IL', { day:'2-digit', month:'2-digit' });
                const timeStart = formatTime24(dStart);
                const timeEnd = formatTime24(dEnd);
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.employeeName}</td>
                    <td>${s.idNum || '-'}</td>
                    <td dir="ltr">${dateStr} ${timeStart}</td>
                    <td dir="ltr">${timeEnd}</td>
                    <td>${s.totalHours}</td>
                    <td>${s.hourlyWage}</td>
                    <td>${s.tips}</td>
                    <td>${s.supplement > 0 ? s.supplement : '-'}</td>
                    <td style="font-weight:bold;">${s.finalPay} â‚ª</td>
                `;
                tbody.appendChild(tr);
            });
            window.currentExportData = shifts;
        };

        window.changeMonth = (delta) => {
            currentDateView.setMonth(currentDateView.getMonth() + delta);
            loadCalendar();
        }

        window.loadCalendar = async () => {
            const allShifts = await fetchShifts();
            const filterUser = document.getElementById('calFilterUser').value;
            
            // ×¡×™× ×•×Ÿ ×œ×¤×™ ××©×ª××© ×× × ×‘×—×¨
            const shifts = (filterUser === 'all') 
                ? allShifts 
                : allShifts.filter(s => s.username === filterUser);

            const container = document.getElementById('calendarGrid');
            const headers = container.querySelectorAll('.cal-day-header');
            container.innerHTML = '';
            headers.forEach(h => container.appendChild(h));

            const year = currentDateView.getFullYear();
            const month = currentDateView.getMonth();
            const monthNames = ["×™× ×•××¨", "×¤×‘×¨×•××¨", "××¨×¥", "××¤×¨×™×œ", "×××™", "×™×•× ×™", "×™×•×œ×™", "××•×’×•×¡×˜", "×¡×¤×˜××‘×¨", "××•×§×˜×•×‘×¨", "× ×•×‘××‘×¨", "×“×¦××‘×¨"];
            document.getElementById('calMonthTitle').innerText = `${monthNames[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            for(let i=0; i<firstDayOfMonth; i++) {
                const empty = document.createElement('div');
                empty.className = 'cal-day empty';
                container.appendChild(empty);
            }

            for(let day=1; day<=daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'cal-day';
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    cell.classList.add('today');
                }
                cell.innerHTML = `<span style="font-weight:bold; font-size:0.8em;">${day}</span>`;

                const shiftDateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const dailyShifts = shifts.filter(s => s.start.startsWith(shiftDateStr));
                
                if (dailyShifts.length > 0) {
                    dailyShifts.forEach(s => {
                        const tStart = formatTime24(new Date(s.start));
                        const tEnd = formatTime24(new Date(s.end));
                        cell.innerHTML += `<span class="shift-marker" title="${s.employeeName}">
                            ${s.employeeName.split(' ')[0]} ${tStart}-${tEnd}
                        </span>`;
                    });
                }
                container.appendChild(cell);
            }
        };

        window.exportExcel = () => {
            if(!window.currentExportData) return alert("××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×");
            
            const data = window.currentExportData.map(s => ({
                "×©× ×¢×•×‘×“": s.employeeName,
                "×ª×¢×•×“×ª ×–×”×•×ª": s.idNum,
                "×”×ª×—×œ×”": new Date(s.start).toLocaleString('he-IL', { hour12: false }),
                "×¡×™×•×": new Date(s.end).toLocaleString('he-IL', { hour12: false }),
                "×©×¢×•×ª": s.totalHours,
                "×©×›×¨ ×œ×©×¢×”": s.hourlyWage,
                "×˜×™×¤×™×": s.tips,
                "×”×× ×§×™×‘×œ ×˜×™×¤": s.isTippedShift ? '×›×Ÿ' : '×œ×',
                "×”×©×œ××”": s.supplement,
                "×¡×”×› ×œ×ª×©×œ×•×": s.finalPay
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "××©××¨×•×ª");
            XLSX.writeFile(wb, "Shifts_Report.xlsx");
        }

    </script>
</body>
</html>
